let chart,rows=[],cols=[];const $=e=>document.getElementById(e),isNumber=e=>null!==e&&""!==e&&!isNaN(+e),looksLikeDate=e=>{if(!e)return!1;const t=new Date(e);return!isNaN(t.getTime())};function inferTypes(e,t){const a=t.map((e=>({name:e,numeric:0,date:0,empty:0,total:0}))),n=Math.min(e.length,1e3);for(let s=0;s<n;s++){const n=e[s];t.forEach(((e,t)=>{const s=n[e];a[t].total++,null==s||""===s?a[t].empty++:isNumber(s)?a[t].numeric++:looksLikeDate(s)&&a[t].date++}))}return a.map((e=>({name:e.name,kind:e.date>.6*e.total?"date":e.numeric>.6*e.total?"number":"string"})))}function groupBy(e,t){const a=new Map;for(const n of e){const e=n[t];a.has(e)||a.set(e,[]),a.get(e).push(n)}return a}function aggregate(e,t,a){if("count"===a)return e.length;const n=e.map((e=>+e[t])).filter((e=>!isNaN(e)));if(0===n.length)return null;if("sum"===a)return n.reduce(((e,t)=>e+t),0);if("avg"===a)return n.reduce(((e,t)=>e+t),0)/n.length;if("median"===a){n.sort(((e,t)=>e-t));const e=Math.floor(n.length/2);return n.length%2!=0?n[e]:(n[e-1]+n[e])/2}return null}function makeSuggestions(e){const t=[],a=e.filter((e=>"date"===e.kind)).map((e=>e.name)),n=e.filter((e=>"number"===e.kind)).map((e=>e.name)),s=e.filter((e=>"string"===e.kind)).map((e=>e.name));return a.length&&n.length&&t.push({label:`Line: ${n[0]} over ${a[0]}`,type:"line",x:a[0],y:[n[0]],agg:"none"}),s.length&&n.length&&t.push({label:`Bar: ${n[0]} by ${s[0]}`,type:"bar",x:s[0],y:[n[0]],agg:"avg"}),n.length>=2&&t.push({label:`Scatter: ${n[0]} vs ${n[1]}`,type:"scatter",x:n[0],y:[n[1]],agg:"none"}),s.length&&n.length&&t.push({label:`Pie: ${n[0]} by ${s[0]}`,type:"pie",x:s[0],y:[n[0]],agg:"sum"}),t}function updateSelectors(e){const t=$("xCol"),a=$("yCol");t.innerHTML="",a.innerHTML="",e.forEach((e=>{const n=document.createElement("option");n.value=n.textContent=e.name,t.appendChild(n);const s=document.createElement("option");s.value=s.textContent=e.name,a.appendChild(s)}))}function renderSuggestions(e){const t=$("suggestions");t.innerHTML="",e.forEach((e=>{const a=document.createElement("button");a.textContent=e.label,a.className="ghost",a.onclick=()=>{$("chartType").value=e.type,$("xCol").value=e.x,[...$("yCol").options].forEach((t=>t.selected=e.y.includes(t.value))),$("agg").value=e.agg,drawChart()},t.appendChild(a)}))}function drawChart(){if(!rows.length||!cols.length)return;const e=inferTypes(rows,cols),t=$("chartType").value,a=$("xCol").value||e[0].name,n=[...$("yCol").selectedOptions].map((e=>e.value)),s=$("agg").value,r="auto"===t?looksLikeDate(rows[0][a])?"line":"bar":t;let o=[],i=[];if("pie"===r){const e=groupBy(rows,a),t=n[0];o=[...e.keys()];const r=o.map((a=>aggregate(e.get(a),t,"none"===s?"sum":s)||0));i=[{label:t,data:r}]}else if("none"===s||"scatter"===r)"scatter"===r&&n[0]?i=[{label:`${n[0]} vs ${a}`,data:rows.filter((e=>isNumber(e[a])&&isNumber(e[n[0]]))).map((e=>({x:+e[a],y:+e[n[0]]})))}]:(o=rows.map((e=>e[a])),i=n.map((e=>({label:e,data:rows.map((t=>isNumber(t[e])?+t[e]:null))}))));else{const e=groupBy(rows,a);o=[...e.keys()],i=n.map((t=>({label:t,data:o.map((a=>aggregate(e.get(a),t,s)||0))})))}const l=$("chart").getContext("2d");chart&&chart.destroy(),chart=new Chart(l,{type:"scatter"===r?"scatter":"line"===r?"line":"bar"===r?"bar":"pie",data:{labels:o,datasets:i},options:{responsive:!0,interaction:{mode:"index",intersect:!1},plugins:{legend:{position:"bottom"},title:{display:!1}},scales:"pie"===r?{}:{x:{ticks:{maxRotation:45,minRotation:0}}}}}),updateEmbed()}function updateEmbed(){const e=location.href;$("embedCode").value=`<iframe src="${e}" style="width:100%;min-height:460px;border:0;border-radius:16px"></iframe>`}async function parseFile(e){const t=e.name.toLowerCase();if(t.endsWith(".csv")||t.endsWith(".tsv")||t.endsWith(".txt"))return new Promise((t=>{Papa.parse(e,{header:!0,skipEmptyLines:!0,dynamicTyping:!1,complete:e=>t(e.data)})}));const a=await e.arrayBuffer(),n=XLSX.read(a,{type:"array"}),s=n.Sheets[n.SheetNames[0]];return XLSX.utils.sheet_to_json(s,{defval:""})}async function parseCSVText(e){return new Promise((t=>{Papa.parse(e,{header:!0,skipEmptyLines:!0,dynamicTyping:!1,complete:e=>t(e.data)})}))}function setData(e){rows=e,cols=rows.length?Object.keys(rows[0]):[],$("rowCount").textContent=`rows: ${rows.length}`,$("colCount").textContent=`cols: ${cols.length}`,$("status").textContent=rows.length?"Loaded ✓":"No rows found";const t=inferTypes(rows,cols);updateSelectors(t),renderSuggestions(makeSuggestions(t));const a=$("suggestions").querySelector("button");a&&a.click(),saveToHash()}function saveToHash(){try{const e=JSON.stringify({rows:rows,settings:{type:$("chartType").value,x:$("xCol").value,y:[...$("yCol").selectedOptions].map((e=>e.value)),agg:$("agg").value}}),t=LZString.compressToEncodedURIComponent(e);t.length<15e4?location.hash=t:(location.hash="",console.warn("Dataset too large for hash share")),updateEmbed()}catch(e){console.warn(e)}}function restoreFromHash(){if(location.hash)try{const e=JSON.parse(LZString.decompressFromEncodedURIComponent(location.hash.slice(1))||"{}");e.rows&&Array.isArray(e.rows)&&(setData(e.rows),e.settings&&($("chartType").value=e.settings.type||"auto",$("xCol").value=e.settings.x||$("xCol").value,[...$("yCol").options].forEach((t=>t.selected=(e.settings.y||[]).includes(t.value))),$("agg").value=e.settings.agg||"none",drawChart()))}catch(e){console.warn("Failed to restore from hash",e)}}$("file").addEventListener("change",(async e=>{if(!e.target.files?.length)return;$("status").textContent="Parsing…";setData(await parseFile(e.target.files[0]))})),$("drop").addEventListener("dragover",(e=>{e.preventDefault(),$("drop").classList.add("drag")})),$("drop").addEventListener("dragleave",(()=>$("drop").classList.remove("drag"))),$("drop").addEventListener("drop",(async e=>{e.preventDefault(),$("drop").classList.remove("drag");const t=e.dataTransfer.files?.[0];if(!t)return;$("status").textContent="Parsing…";setData(await parseFile(t))})),$("fetchBtn").addEventListener("click",(async()=>{const e=$("url").value.trim();if(!e)return alert("Enter a CSV or XLSX URL");$("status").textContent="Fetching…";try{const t=await fetch(e);if((t.headers.get("content-type")||"").includes("application/vnd")||e.match(/\.xlsx?$/)){const e=await t.arrayBuffer(),a=XLSX.read(e,{type:"array"}),n=a.Sheets[a.SheetNames[0]];setData(XLSX.utils.sheet_to_json(n,{defval:""}))}else{const e=await t.text();setData(await parseCSVText(e))}}catch(e){console.error(e),alert("Failed to fetch or parse file. Check CORS."),$("status").textContent="Fetch failed"}})),$("sampleBtn").addEventListener("click",(()=>{Papa.parse("date,product,region,sales\n2025-01-01,A,North,120\n2025-01-02,A,South,90\n2025-01-03,B,North,150\n2025-01-04,B,South,80\n2025-01-05,A,West,130\n2025-01-06,C,North,60\n2025-01-07,C,West,95\n2025-01-08,B,South,110",{header:!0,complete:e=>setData(e.data)})})),$("renderBtn").addEventListener("click",(()=>{drawChart(),saveToHash()})),$("chartType").addEventListener("change",(()=>{drawChart(),saveToHash()})),$("xCol").addEventListener("change",(()=>{drawChart(),saveToHash()})),$("yCol").addEventListener("change",(()=>{drawChart(),saveToHash()})),$("agg").addEventListener("change",(()=>{drawChart(),saveToHash()})),$("downloadPNG").addEventListener("click",(()=>{if(!chart)return;const e=document.createElement("a");e.href=$("chart").toDataURL("image/png"),e.download="chart.png",e.click()})),$("shareBtn").addEventListener("click",(()=>{saveToHash(),navigator.clipboard.writeText(location.href),alert("Link copied to clipboard!")})),window.addEventListener("hashchange",restoreFromHash),restoreFromHash();